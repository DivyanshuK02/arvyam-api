# Deploy — Render Web Service (minimal)

This project deploys as a **Render Web Service**. Keep deployment knobs out of README to avoid drift; this page is the single source for deploy basics.

## Service settings
- **Service type:** Web Service
- **Runtime:** Python 3.11
- **Region:** (choose closest to your users)
- **Auto-deploy:** From `main` branch (recommended)

## Commands
**Build:**
```bash
pip install -r requirements.txt
```

**Start:**
```bash
uvicorn app.main:app --host 0.0.0.0 --port $PORT
```

> Render supplies `$PORT`. No other env vars are required for v1 core features.

## Environment variables

### Phase 1.x (core API)
No env vars required for basic operation. Optional:
- `ARVY_VERSION` (default: v1) — Version string in /health
- `RATE_LIMIT_PER_MIN` (default: 10) — Rate limit per IP
- `SESSION_TTL_SECONDS` (default: 1800) — Session expiry
- `SESSION_MAX` (default: 1000) — Max sessions in memory

### Phase 3.1 (accounts & memory) — Optional
Required only if enabling Phase 3.1 features:

**Database:**
- `SUPABASE_URL` — Supabase project URL
- `SUPABASE_KEY` — Supabase service key

**Auth:**
- `JWT_SECRET` — Random 32+ char string for token signing

**OTP:**
- `OTP_PROVIDER` (default: stub) — Provider: stub, resend, or sendgrid
- `OTP_API_KEY` — Provider API key (ignored when stub)

**Feature flags (all OFF by default):**
- `AUTH_ENDPOINTS_ENABLED` — Enable /auth/request-otp, /auth/verify-otp
- `MEMORY_ENDPOINTS_ENABLED` — Enable /forget-me, /export-data, /profile
- `MEMORY_CONTEXT_ENABLED` — Enable memory context building
- `MEMORY_RERANK_ENABLED` — Enable post-selection reranking

> With all flags OFF, system behaves exactly as Phase 1.x (guest-first, no accounts).

## Notes
- Public API v1 is **packaging-blind**: no `packaging` or `luxury_grand` leaves the server.
- CI must be green before deploy (contract + guards + golden harness).
- Rollback = deploy a prior commit from Render's "Manual Deploy" (no code changes needed).
- Phase 3.1 rollback = set feature flags to OFF (immediate, non-destructive).

## Pre-deploy checklist

### Phase 1.x (always)
- [ ] `pytest -q` passes locally
- [ ] Evidence/artifacts generated by golden harness (optional for prod)
- [ ] No changes to public schema (v1 freeze)

### Phase 3.1 (if enabling accounts/memory)
- [ ] Supabase project created and URL/KEY configured
- [ ] Migration `001_phase_3_1.sql` run in Supabase dashboard
- [ ] `JWT_SECRET` set (32+ random characters)
- [ ] OTP provider configured (or leave as stub for testing)
- [ ] Feature flags set to desired state
- [ ] Test auth flow: request-otp → verify-otp → token issued
- [ ] Test privacy flow: /forget-me cascade delete works

---

## Phase-1 §1.6 — Catalog Schema Freeze (notes)

### Public API allow-list (v1)
Return only these keys per item:
`id`, `title`, `desc`, `image`, `price`, `currency`, `emotion`, `tier`, `mono`, `palette`
Optional: `note`, `edge_case`, `edge_type`

### Strictly forbidden to leak
`packaging`, `luxury_grand`, `image_url`, `price_inr`, `flowers`, `weight`, `tags`, and any private/underscored keys.

**LLM Feeder Note:** Fields like `tags/flowers/packaging/...` are for **LLM feeder and internal tooling only**. They are not part of the public API and must **never** be surfaced by `/api/curate`.

### Sobriety note — grief/farewell
For sympathy/farewell families, palettes must stay muted and respectful.
Gold accents are acceptable in moderation; celebratory/neon tones are blocked by tests/policy.

### CI ordering (post-P1.6)
1. Rulebook validation  
2. Catalog JSON-schema validation (this phase)  
3. Test suite (contract, golden harness, boundaries/fallbacks)

### Phase flag
`docs/phase_status.json` carries `"1.6_catalog_schema": "frozen"`.

---

## Phase-3 §3.1 — User Accounts & Memory (notes)

### Database tables (Supabase)
- `users` — id, email, phone, memory_opt_in, created_at
- `orders` — id, user_id (nullable), email, sku_id, emotion, created_at
- `recipient_profiles` — id, user_id, name, preferences (jsonb), schema_version
- `otp_codes` — id, email, otp_hash, expires_at, attempts, created_at

### New endpoints (feature-flagged)
**Auth (AUTH_ENDPOINTS_ENABLED):**
- POST /auth/request-otp — Generate OTP, send via provider
- POST /auth/verify-otp — Verify OTP, issue 24h signed token

**Privacy (MEMORY_ENDPOINTS_ENABLED):**
- POST /forget-me — OTP-verified cascade delete (DSAR)
- POST /export-data — OTP-verified JSON export (DSAR)
- GET /profile — List recipient profiles (JWT required)
- POST /profile — Create/update profile (JWT required)

### Selection invariance (CRITICAL)
Memory affects ordering and copy tone ONLY. SKU IDs and 2 MIX + 1 MONO composition remain unchanged. Rerank weights bounded at ≤0.3 with deterministic tie-break.

### Retention job
`scripts/retention_job.py` — Deletes data older than 90 days for non-opted-in users.
Run via Render Cron or external scheduler. Idempotent and logs actions.

### Rate limits
- /auth/* endpoints: 10/min per IP, 20/day per email
- /forget-me, /export-data: 5/min per IP
- /profile: 10/min per IP

### Phase flag
`docs/phase_status.json` carries `"3.1_user_accounts": "frozen"`.
